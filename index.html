<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรับส่งหนังสือราชการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            background-color: #e0f2fe; /* สีฟ้าอ่อน */
            color: #0b527e; /* สีน้ำเงินเข้ม */
            border-bottom: 2px solid #0b527e;
        }
        .tab-inactive {
            background-color: #f8fafc; /* สีพื้นหลังอ่อน */
            color: #4b5563; /* สีเทา */
        }
        .tab-inactive:hover {
            background-color: #f1f5f9; /* สีพื้นหลังเมื่อโฮเวอร์ */
        }
        .form-section {
            background-color: #ffffff; /* สีขาว */
            padding: 2rem;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); /* shadow-sm */
            margin-bottom: 2rem;
        }
        .table-section {
            background-color: #ffffff; /* สีขาว */
            padding: 2rem;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); /* shadow-sm */
            margin-bottom: 2rem;
        }

        /* Styles for iOS-like blue */
        .ios-blue {
            background-color: #007aff;
            color: white;
        }

        .ios-blue:hover {
            background-color: #0064d1;
        }

        /* Pastel color scheme */
        .pastel-blue {
            background-color: #e0f7fa; /* Light cyan */
            color: #00897b; /* Teal */
        }

        .pastel-blue:hover {
            background-color: #b2ebf2; /* Lighter cyan */
        }

        .pastel-pink {
            background-color: #fce4ec; /* Light pink */
            color: #c2185b; /* Deep pink */
        }

        .pastel-pink:hover {
            background-color: #f8bbd0; /* Lighter pink */
        }

        .pastel-green {
            background-color: #f0f4c3; /* Light yellow-green */
            color: #7cb342; /* Light green */
        }

        .pastel-green:hover {
            background-color: #e6ee96; /* Lighter yellow-green */
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-500 text-white py-4 flex justify-center items-center">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Seal_of_Ko_Samui.png" alt="Seal of Ko Samui" height="100" class="mr-4">
        <h1 class="text-2xl font-semibold">ระบบรับส่งหนังสือราชการ</h1>
    </header>

    <nav class="bg-gray-200 py-2">
        <div class="container mx-auto flex justify-center">
            <button id="tab-receive" class="tab tab-active px-4 py-2 rounded-md mr-2 focus:outline-none">หนังสือรับ</button>
            <button id="tab-send" class="tab tab-inactive px-4 py-2 rounded-md focus:outline-none">หนังสือส่ง</button>
            <button id="tab-statistics" class="tab tab-inactive px-4 py-2 rounded-md focus:outline-none">สถิติ</button> </div>
    </nav>

    <main class="container mx-auto mt-4">
        <section id="section-receive" class="section">
            <div class="form-section">
                <h2 class="text-xl font-semibold mb-4">หนังสือรับ</h2>
                <form id="receive-form" class="space-y-4">
                    <div>
                        <label for="receive-date" class="block text-gray-700 text-sm font-bold mb-2">วันที่รับ:</label>
                        <input type="date" id="receive-date" name="receive-date" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="receive-reg-no" class="block text-gray-700 text-sm font-bold mb-2">ทะเบียนรับเทศบาล:</label>
                        <input type="text" id="receive-reg-no" name="receive-reg-no" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="receive-type" class="block text-gray-700 text-sm font-bold mb-2">ประเภทหนังสือราชการ:</label>
                        <select id="receive-type" name="receive-type" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">เลือกประเภทหนังสือ</option>
                            <option value="ภายใน">หนังสือภายใน</option>
                            <option value="ภายนอก">หนังสือภายนอก</option>
                            <option value="คำสั่ง">คำสั่ง</option>
                            <option value="ประกาศ">ประกาศ</option>
                            <option value="รายงาน">รายงาน</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div>
                        <label for="receive-work-group" class="block text-gray-700 text-sm font-bold mb-2">หมวดหมู่หนังสือเข้างาน:</label>
                        <select id="receive-work-group" name="receive-work-group" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">เลือกหมวดหมู่</option>
                            <option value="บริหารทั่วไป">งานบริหารทั่วไป</option>
                            <option value="ปรับปรุงคุณภาพน้ำ">ฝ่ายปรับปรุงคุณภาพน้ำ</option>
                            <option value="จัดการสิ่งแวดล้อม">ฝ่ายจัดการสิ่งแวดล้อมด้านวัสดุใช้แล้ว</option>
                        </select>
                    </div>
                    <div>
                        <label for="receive-subject" class="block text-gray-700 text-sm font-bold mb-2">หัวเรื่อง:</label>
                        <input type="text" id="receive-subject" name="receive-subject" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="receive-sender" class="block text-gray-700 text-sm font-bold mb-2">ผู้ส่ง:</label>
                        <input type="text" id="receive-sender" name="receive-sender" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="receive-send-date" class="block text-gray-700 text-sm font-bold mb-2">วันที่ส่ง:</label>
                        <input type="date" id="receive-send-date" name="receive-send-date" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="receive-receiver" class="block text-gray-700 text-sm font-bold mb-2">ผู้รับ:</label>
                        <input type="text" id="receive-receiver" name="receive-receiver" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="receive-status" class="block text-gray-700 text-sm font-bold mb-2">สถานะ:</label>
                        <select id="receive-status" name="receive-status" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">เลือกสถานะ</option>
                            <option value="อยู่ระหว่างเสนอ">อยู่ระหว่างเสนอ</option>
                            <option value="ดำเนินการแล้วเสร็จ">ดำเนินการแล้วเสร็จ</option>
                        </select>
                    </div>
                    <div>
                        <label for="receive-recorder" class="block text-gray-700 text-sm font-bold mb-2">ผู้บันทึกข้อมูล:</label>
                        <input type="text" id="receive-recorder" name="receive-recorder" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="receive-file" class="block text-gray-700 text-sm font-bold mb-2">อัพโหลดเอกสาร:</label>
                        <input type="file" id="receive-file" name="receive-file" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">บันทึกข้อมูล</button>
                    <div id="receive-status-message" class="mt-4 text-yellow-600 font-semibold"></div>
                </form>
            </div>

            <div class="table-section">
                <h3 class="text-lg font-semibold mb-4">รายการหนังสือรับ (อยู่ระหว่างดำเนินการ)</h3>
                <div class="mb-4">
                    <input type="text" id="receive-search" placeholder="ค้นหา..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2">
                    <select id="receive-filter-status" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">ทุกสถานะ</option>
                        <option value="อยู่ระหว่างเสนอ">อยู่ระหว่างเสนอ</option>
                        <option value="ดำเนินการแล้วเสร็จ">ดำเนินการแล้วเสร็จ</option>
                    </select>
                </div>
                <table id="receive-table" class="min-w-full table-auto rounded-lg hidden">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-2 text-left">ทะเบียนรับเทศบาล</th>
                            <th class="px-4 py-2 text-left">วันที่รับ</th>
                            <th class="px-4 py-2 text-left">ประเภทหนังสือราชการ</th>
                            <th class="px-4 py-2 text-left">หัวเรื่อง</th>
                            <th class="px-4 py-2 text-left">ผู้ส่ง</th>
                            <th class="px-4 py-2 text-left">วันที่ส่ง</th>
                            <th class="px-4 py-2 text-left">ผู้รับ</th>
                            <th class="px-4 py-2 text-left">สถานะ</th>
                            <th class="px-4 py-2 text-left">การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700">
                        <tr>
                            <td colspan="9" class="px-4 py-2 text-center text-gray-500">ไม่มีข้อมูล</td>
                        </tr>
                    </tbody>
                </table>
                <div id="receive-table-message" class="mt-4 text-gray-500 text-center">Loading data...</div>
            </div>
        </section>

        <section id="section-send" class="section hidden">
            <div class="form-section">
                <h2 class="text-xl font-semibold mb-4">หนังสือส่ง</h2>
                <form id="send-form" class="space-y-4">
                    <div>
                        <label for="send-date" class="block text-gray-700 text-sm font-bold mb-2">วันที่ส่ง:</label>
                        <input type="date" id="send-date" name="send-date" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="send-reg-no" class="block text-gray-700 text-sm font-bold mb-2">ทะเบียนส่ง:</label>
                        <input type="text" id="send-reg-no" name="send-reg-no" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="send-type" class="block text-gray-700 text-sm font-bold mb-2">ประเภทหนังสือ:</label>
                        <select id="send-type" name="send-type" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">เลือกประเภทหนังสือ</option>
                            <option value="ภายใน">หนังสือภายใน</option>
                            <option value="ภายนอก">หนังสือภายนอก</option>
                            <option value="คำสั่ง">คำสั่ง</option>
                            <option value="ประกาศ">ประกาศ</option>
                            <option value="รายงาน">รายงาน</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div>
                        <label for="send-subject" class="block text-gray-700 text-sm font-bold mb-2">หัวเรื่อง:</label>
                        <input type="text" id="send-subject" name="send-subject" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="send-receiver" class="block text-gray-700 text-sm font-bold mb-2">ผู้รับ:</label>
                        <input type="text" id="send-receiver" name="send-receiver" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="send-receive-date" class="block text-gray-700 text-sm font-bold mb-2">วันที่รับเรื่อง:</label>
                        <input type="date" id="send-receive-date" name="send-receive-date" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="send-status" class="block text-gray-700 text-sm font-bold mb-2">สถานะ:</label>
                        <select id="send-status" name="send-status" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">เลือกสถานะ</option>
                            <option value="อยู่ระหว่างเสนอ">อยู่ระหว่างเสนอ</option>
                            <option value="ดำเนินการแล้วเสร็จ">ดำเนินการแล้วเสร็จ</option>
                        </select>
                    </div>
                    <div>
                        <label for="send-recorder" class="block text-gray-700 text-sm font-bold mb-2">ผู้บันทึกข้อมูล:</label>
                        <input type="text" id="send-recorder" name="send-recorder" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="send-file" class="block text-gray-700 text-sm font-bold mb-2">อัพโหลดเอกสาร:</label>
                        <input type="file" id="send-file" name="send-file" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">บันทึกข้อมูล</button>
                    <div id="send-status-message" class="mt-4 text-yellow-600 font-semibold"></div>
                </form>
            </div>

            <div class="table-section">
                <h3 class="text-lg font-semibold mb-4">รายการหนังสือส่ง (อยู่ระหว่างดำเนินการ)</h3>
                <div class="mb-4">
                    <input type="text" id="send-search" placeholder="ค้นหา..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2">
                    <select id="send-filter-status" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">ทุกสถานะ</option>
                        <option value="อยู่ระหว่างเสนอ">อยู่ระหว่างเสนอ</option>
                        <option value="ดำเนินการแล้วเสร็จ">ดำเนินการแล้วเสร็จ</option>
                    </select>
                </div>
                <table id="send-table" class="min-w-full table-auto rounded-lg hidden">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-2 text-left">ทะเบียนส่ง</th>
                            <th class="px-4 py-2 text-left">วันที่ส่ง</th>
                            <th class="px-4 py-2 text-left">ประเภทหนังสือ</th>
                            <th class="px-4 py-2 text-left">หัวเรื่อง</th>
                            <th class="px-4 py-2 text-left">ผู้รับ</th>
                            <th class="px-4 py-2 text-left">วันที่รับเรื่อง</th>
                            <th class="px-4 py-2 text-left">สถานะ</th>
                            <th class="px-4 py-2 text-left">การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700">
                        <tr>
                            <td colspan="8" class="px-4 py-2 text-center text-gray-500">ไม่มีข้อมูล</td>
                        </tr>
                    </tbody>
                </table>
                <div id="send-table-message" class="mt-4 text-gray-500 text-center">Loading data...</div>
            </div>
        </section>

        <section id="section-statistics" class="section hidden">
            <div class="bg-white p-6 rounded-md shadow-md">
                <h2 class="text-2xl font-semibold mb-4">สถิติ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">สถิติหนังสือรับ</h3>
                        <ul id="receive-statistics-list" class="list-disc list-inside">
                            <li>รวมทั้งหมด: <span id="receive-total">0</span> ฉบับ</li>
                            <li>อยู่ระหว่างดำเนินการ: <span id="receive-pending">0</span> ฉบับ</li>
                            <li>ดำเนินการแล้วเสร็จ: <span id="receive-completed">0</span> ฉบับ</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">สถิติหนังสือส่ง</h3>
                        <ul id="send-statistics-list" class="list-disc list-inside">
                            <li>รวมทั้งหมด: <span id="send-total">0</span> ฉบับ</li>
                            <li>อยู่ระหว่างดำเนินการ: <span id="send-pending">0</span> ฉบับ</li>
                            <li>ดำเนินการแล้วเสร็จ: <span id="send-completed">0</span> ฉบับ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-200 text-gray-700 py-4 text-center mt-8">
        © 2025 ระบบบริหารจัดการงานกองช่างสุขาภิบาล โดย นายธีรศักดิ์ พูลเขาล้าน
    </footer>

    <script>
        const tabs = document.querySelectorAll('.tab');
        const sections = document.querySelectorAll('.section');
        const receiveForm = document.getElementById('receive-form');
        const sendForm = document.getElementById('send-form');
        const receiveTable = document.getElementById('receive-table');
        const sendTable = document.getElementById('send-table');
        const receiveStatusMessage = document.getElementById('receive-status-message');
        const sendStatusMessage = document.getElementById('send-status-message');
        const receiveSearchInput = document.getElementById('receive-search');
        const sendSearchInput = document.getElementById('send-search');
        const receiveFilterStatus = document.getElementById('receive-filter-status');
        const sendFilterStatus = document.getElementById('send-filter-status');

        // Get Statistics Elements
        const receiveTotalElement = document.getElementById('receive-total');
        const receivePendingElement = document.getElementById('receive-pending');
        const receiveCompletedElement = document.getElementById('receive-completed');
        const sendTotalElement = document.getElementById('send-total');
        const sendPendingElement = document.getElementById('send-pending');
        const sendCompletedElement = document.getElementById('send-completed');
        const tabStatistics = document.getElementById('tab-statistics'); // Get the tab
        const sectionStatistics = document.getElementById('section-statistics'); // Get the section

        let receiveData = [];
        let sendData = [];
        let editingId = null;
        let currentTab = 'receive'; // Keep track of the current tab

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyGs5cVEgNWbAcbG5O61SKaNhe22uAlaBJVSEaXZDF33h_ngggQcomaVGL5lhMSHfF2WQ/exec'; // Replace with your Google Apps Script URL
        const SHEET_ID = '1uOo_wsWfA7cO3initNwUaoseXtNLuDEmDQ2O5A5v1S8'; // Replace with your Google Sheet ID
        const FOLDER_ID = '1Miz44jDIMrl1ZGmSEt23TXNu7rzK-1w1'; // Replace with your Google Drive Folder ID

        function openTab(evt, tabId) {
            document.querySelectorAll('.tab-active').forEach(el => el.classList.remove('tab-active'));
            sections.forEach(section => section.classList.add('hidden'));

            const activeTab = document.getElementById(`tab-${tabId}`);
            const activeSection = document.getElementById(`section-${tabId}`);

            activeTab.classList.add('tab-active');
            activeSection.classList.remove('hidden');
            currentTab = tabId; // Update currentTab
             if (tabId === 'statistics') {
                updateStatistics();
            } else {
                loadExistingData(tabId); // Load data when switching tabs
            }
        }



        // Event listeners for tab switching
document.getElementById('tab-receive').addEventListener('click', () => openTab(event, 'receive'));
document.getElementById('tab-send').addEventListener('click', () => openTab(event, 'send'));
document.getElementById('tab-statistics').addEventListener('click', () => openTab(event, 'statistics'));

// Initial tab setup
openTab(null, 'receive');

        // Function to handle form submission (add/edit data)
        async function handleSubmit(event, formType) {
            event.preventDefault();

            const statusMessageElement = formType === 'receive' ? receiveStatusMessage : sendStatusMessage;
            statusMessageElement.textContent = 'กำลังบันทึกข้อมูล...';

            const formData = new FormData(event.target);
            const data = {};
            formData.forEach((value, key) => {
                if (key === 'receive-file' || key === 'send-file') {
                    // Handle file upload separately
                    const file = formData.get(key);
                    if (file.size > 0) {
                        // In a real scenario, you would upload the file to Google Drive
                        // and get the URL.  For this example, we'll just store the filename.
                        data[key] = file.name;  // Store the filename
                    } else {
                        data[key] = ''; // No file uploaded
                    }
                } else {
                    data[key] = value;
                }
            });

            if (editingId) {
                data.id = editingId;
            } else {
                data.id = Date.now();
            }

            // Determine the sheet name based on the form type
            const sheetName = formType === 'receive' ? 'receive' : 'send';

            // Prepare the data for sending to Google Apps Script
            const requestData = {
                action: editingId ? 'editData' : 'addData',
                sheetName: sheetName,
                data: data,
            };
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });

                const result = await response.json();
                handleResponse(result, formType);

            } catch (error) {
                console.error("Error submitting form:", error);
                statusMessageElement.textContent = 'เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message;
            } finally {
                editingId = null;
            }
        }



        // Attach event listeners to the forms
        receiveForm.addEventListener('submit', (event) => handleSubmit(event, 'receive'));
        sendForm.addEventListener('submit', (event) => handleSubmit(event, 'send'));

        // Callback function to handle the response from Google Apps Script
        function handleResponse(response, formType) {
            const statusMessageElement = formType === 'receive' ? receiveStatusMessage : sendStatusMessage;

            if (response.success) {
                statusMessageElement.textContent = 'บันทึกข้อมูลสำเร็จ';
                if (formType === 'receive') {
                    receiveForm.reset();
                    loadExistingData('receive'); // Reload receive data
                } else {
                    sendForm.reset();
                    loadExistingData('send'); // Reload send data
                }

            } else {
                statusMessageElement.textContent = 'เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + response.message;
            }
            setTimeout(() => {
                statusMessageElement.textContent = ''; // Clear message
            }, 5000);
        }

        // Function to load existing data from Google Sheets
        async function loadExistingData(sheetName) {
            const table = sheetName === 'receive' ? receiveTable : sendTable;
            const tableMessageElement = sheetName === 'receive' ? document.getElementById('receive-table-message') : document.getElementById('send-table-message');

            tableMessageElement.textContent = 'กำลังโหลดข้อมูล...';
            table.classList.add('hidden'); // Hide the table initially
            try {
                const requestData = {
                    action: 'getData',
                    sheetName: sheetName,
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    if (sheetName === 'receive') {
                        receiveData = data;
                    } else if (sheetName === 'send') {
                        sendData = data;
                    }
                    populateTable(data, sheetName);
                    tableMessageElement.textContent = ''; // Clear message
                    table.classList.remove('hidden'); // Show the table
                } else {
                    tableMessageElement.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + result.message;
                    table.classList.add('hidden'); // Ensure table is hidden on error
                }
            } catch (error) {
                console.error("Error fetching data:", error);
                tableMessageElement.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message;
                table.classList.add('hidden');
            }
        }

        // Function to populate the table with data
        function populateTable(data, sheetName) {
            const table = sheetName === 'receive' ? receiveTable : sendTable;
            const tableBody = table.querySelector('tbody');
            tableBody.innerHTML = ''; // Clear existing table rows

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${sheetName === 'receive' ? 9 : 8}" class="px-4 py-2 text-center text-gray-500">ไม่มีข้อมูล</td></tr>`;
                return;
            }

            data.forEach(item => {
                let rowHtml = '';
                if (sheetName === 'receive') {
                    rowHtml = `
                        <tr>
                            <td class="px-4 py-2">${item['ทะเบียนรับเทศบาล'] || ''}</td>
                            <td class="px-4 py-2">${item['วันที่รับ'] || ''}</td>
                            <td class="px-4 py-2">${item['ประเภทหนังสือราชการ'] || ''}</td>
                            <td class="px-4 py-2">${item['หัวเรื่อง'] || ''}</td>
                            <td class="px-4 py-2">${item['ผู้ส่ง'] || ''}</td>
                            <td class="px-4 py-2">${item['วันที่ส่ง'] || ''}</td>
                            <td class="px-4 py-2">${item['ผู้รับ'] || ''}</td>
                            <td class="px-4 py-2">${item['สถานะ'] || ''}</td>
                            <td class="px-4 py-2">
                                <button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs" onclick="editData('${item.id}', 'receive')">แก้ไข</button>
                                <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs" onclick="deleteData('${item.id}', 'receive')">ลบ</button>
                            </td>
                        </tr>
                    `;
                } else if (sheetName === 'send') {
                    rowHtml = `
                        <tr>
                            <td class="px-4 py-2">${item['ทะเบียนส่ง'] || ''}</td>
                            <td class="px-4 py-2">${item['วันที่ส่ง'] || ''}</td>
                            <td class="px-4 py-2">${item['ประเภทหนังสือ'] || ''}</td>
                            <td class="px-4 py-2">${item['หัวเรื่อง'] || ''}</td>
                            <td class="px-4 py-2">${item['ผู้รับ'] || ''}</td>
                            <td class="px-4 py-2">${item['วันที่รับเรื่อง'] || ''}</td>
                            <td class="px-4 py-2">${item['สถานะ'] || ''}</td>
                            <td class="px-4 py-2">
                                <button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs" onclick="editData('${item.id}', 'send')">แก้ไข</button>
                                 <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs" onclick="deleteData('${item.id}', 'send')">ลบ</button>
                            </td>
                        </tr>
                    `;
                }
                tableBody.insertAdjacentHTML('beforeend', rowHtml);
            });
             // Apply filters
            if (sheetName === 'receive') {
                filterAndDisplayReceiveData();
            }
            if (sheetName === 'send') {
                filterAndDisplaySendData();
            }
        }

        // Function to handle editing of data
        async function editData(id, sheetName) {
            const form = sheetName === 'receive' ? receiveForm : sendForm;
            const data = sheetName === 'receive' ? receiveData : sendData;

            const itemToEdit = data.find(item => item.id === id);
            if (!itemToEdit) {
                alert('ไม่พบข้อมูลที่ต้องการแก้ไข');
                return;
            }

            editingId = id; // Set the editing ID

            // Populate the form with the data
            for (const key in itemToEdit) {
                if (form.elements[key]) {
                    if (form.elements[key].type === 'select-one') {
                         form.elements[key].value = itemToEdit[key];
                    }
                    else if (form.elements[key].type === 'file') {
                        //skip
                    }
                    else {
                        form.elements[key].value = itemToEdit[key];
                    }

                }
            }

            // Change form button text.
            form.querySelector('button[type="submit"]').textContent = 'อัปเดตข้อมูล';

            // Switch to the appropriate tab
            switchTab(sheetName);
        }

        // Function to handle deletion of data
        async function deleteData(id, sheetName) {
            if (!confirm(`ยืนยันการลบข้อมูล?`)) return;

            const requestData = {
                action: 'deleteData',
                sheetName: sheetName,
                id: id,
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });

                const result = await response.json();
                if (result.success) {
                    loadExistingData(sheetName); // Reload data
                    alert('ลบข้อมูลสำเร็จ');
                } else {
                    alert('เกิดข้อผิดพลาดในการลบข้อมูล: ' + result.message);
                }
            } catch (error) {
                console.error("Error deleting data:", error);
                alert('เกิดข้อผิดพลาดในการลบข้อมูล: ' + error.message);
            }
        }



        // Event listener for filtering receive data
        receiveSearchInput.addEventListener('input', filterAndDisplayReceiveData);
        receiveFilterStatus.addEventListener('change', filterAndDisplayReceiveData);

        // Event listener for filtering send data
        sendSearchInput.addEventListener('input', filterAndDisplaySendData);
        sendFilterStatus.addEventListener('change', filterAndDisplaySendData);

        // Function to filter and display receive data
        function filterAndDisplayReceiveData() {
            const searchTerm = receiveSearchInput.value.toLowerCase();
            const filterStatus = receiveFilterStatus.value;

            const filteredData = receiveData.filter(item => {
                const searchMatch =
                    item['ทะเบียนรับเทศบาล'].toLowerCase().includes(searchTerm) ||
                    item['วันที่รับ'].toLowerCase().includes(searchTerm) ||
                    item['ประเภทหนังสือราชการ'].toLowerCase().includes(searchTerm) ||
                    item['หัวเรื่อง'].toLowerCase().includes(searchTerm) ||
                    item['ผู้ส่ง'].toLowerCase().includes(searchTerm) ||
                    item['ผู้รับ'].toLowerCase().includes(searchTerm);

                const statusMatch = !filterStatus || item['สถานะ'] === filterStatus;

                return searchMatch && statusMatch;
            });

            const receiveTableBody = receiveTable.querySelector('tbody');
            receiveTableBody.innerHTML = ''; // Clear existing table rows

            if (filteredData.length === 0) {
                receiveTableBody.innerHTML = `<tr><td colspan="9" class="px-4 py-2 text-center text-gray-500">ไม่มีข้อมูล</td></tr>`;
            } else {
                filteredData.forEach(item => {
                    const rowHtml = `
                        <tr>
                            <td class="px-4 py-2">${item['ทะเบียนรับเทศบาล'] || ''}</td>
                            <td class="px-4 py-2">${item['วันที่รับ'] || ''}</td>
                            <td class="px-4 py-2">${item['ประเภทหนังสือราชการ'] || ''}</td>
                            <td class="px-4 py-2">${item['หัวเรื่อง'] || ''}</td>
                            <td class="px-4 py-2">${item['ผู้ส่ง'] || ''}</td>
                            <td class="px-4 py-2">${item['วันที่ส่ง'] || ''}</td>
                            <td class="px-4 py-2">${item['ผู้รับ'] || ''}</td>
                            <td class="px-4 py-2">${item['สถานะ'] || ''}</td>
                            <td class="px-4 py-2">
                                <button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs" onclick="editData('${item.id}', 'receive')">แก้ไข</button>
                                <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs" onclick="deleteData('${item.id}', 'receive')">ลบ</button>
                            </td>
                        </tr>
                    `;
                    receiveTableBody.insertAdjacentHTML('beforeend', rowHtml);
                });
            }
        }

        // Function to filter and display send data
        function filterAndDisplaySendData() {
            const searchTerm = sendSearchInput.value.toLowerCase();
            const filterStatus = sendFilterStatus.value;

            const filteredData = sendData.filter(item => {
                const searchMatch =
                    item['ทะเบียนส่ง'].toLowerCase().includes(searchTerm) ||
                    item['วันที่ส่ง'].toLowerCase().includes(searchTerm) ||
                    item['ประเภทหนังสือ'].toLowerCase().includes(searchTerm) ||
                    item['หัวเรื่อง'].toLowerCase().includes(searchTerm) ||
                    item['ผู้รับ'].toLowerCase().includes(searchTerm) ||
                    item['วันที่รับเรื่อง'].toLowerCase().includes(searchTerm);
                const statusMatch = !filterStatus || item['สถานะ'] === filterStatus;

                return searchMatch && statusMatch;
            });

            const sendTableBody = sendTable.querySelector('tbody');
            sendTableBody.innerHTML = ''; // Clear existing table rows

            if (filteredData.length === 0) {
                sendTableBody.innerHTML = `<tr><td colspan="8" class="px-4 py-2 text-center text-gray-500">ไม่มีข้อมูล</td></tr>`;
            } else {
                filteredData.forEach(item => {
                    const rowHtml = `
                         <tr>
                            <td class="px-4 py-2">${item['ทะเบียนส่ง'] || ''}</td>
                            <td class="px-4 py-2">${item['วันที่ส่ง'] || ''}</td>
                            <td class="px-4 py-2">${item['ประเภทหนังสือ'] || ''}</td>
                            <td class="px-4 py-2">${item['หัวเรื่อง'] || ''}</td>
                            <td class="px-4 py-2">${item['ผู้รับ'] || ''}</td>
                            <td class="px-4 py-2">${item['วันที่รับเรื่อง'] || ''}</td>
                            <td class="px-4 py-2">${item['สถานะ'] || ''}</td>
                            <td class="px-4 py-2">
                                <button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs" onclick="editData('${item.id}', 'send')">แก้ไข</button>
                                 <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs" onclick="deleteData('${item.id}', 'send')">ลบ</button>
                            </td>
                        </tr>
                    `;
                    sendTableBody.insertAdjacentHTML('beforeend', rowHtml);
                });
            }
        }



        async function updateStatistics() {
            try {
                // Fetch receive data
                let receiveResponse = await fetch(SCRIPT_URL + '?action=getData&sheetName=receive');
                let receiveResult = await receiveResponse.json();
                let receiveData = receiveResult.data || [];

                // Fetch send data
                let sendResponse = await fetch(SCRIPT_URL + '?action=getData&sheetName=send');
                let sendResult = await sendResponse.json();
                let sendData = sendResult.data || [];

                // Calculate statistics for receive
                let receiveTotal = receiveData.length;
                let receivePending = receiveData.filter(item => item['สถานะ'] === 'อยู่ระหว่างเสนอ').length;
                let receiveCompleted = receiveData.filter(item => item['สถานะ'] === 'ดำเนินการแล้วเสร็จ').length;

                // Calculate statistics for send
                let sendTotal = sendData.length;
                let sendPending = sendData.filter(item => item['สถานะ'] === 'อยู่ระหว่างเสนอ').length;
                let sendCompleted = sendData.filter(item => item['สถานะ'] === 'ดำเนินการแล้วเสร็จ').length;

                // Update the UI
                receiveTotalElement.textContent = receiveTotal;
                receivePendingElement.textContent = receivePending;
                receiveCompletedElement.textContent = receiveCompleted;
                sendTotalElement.textContent = sendTotal;
                sendPendingElement.textContent = sendPending;
                sendCompletedElement.textContent = sendCompleted;

            } catch (error) {
                console.error("Error fetching statistics:", error);
                // Handle error (e.g., display a message to the user)
                 receiveTotalElement.textContent = 'N/A';
                receivePendingElement.textContent = 'N/A';
                receiveCompletedElement.textContent = 'N/A';
                sendTotalElement.textContent = 'N/A';
                sendPendingElement.textContent = 'N/A';
                sendCompletedElement.textContent = 'N/A';
            }
        }

    </script>
</body>
</html>
